---
import { joinURL, withTrailingSlash } from "ufo";
import { Octokit, type RestEndpointMethodTypes } from "@octokit/rest";

import Layout from "../layouts/Layout.astro";

import { GITHUB_OWNER, GITHUB_REPO, PRODUCTION_BASE_URL } from "../lib/info.js";

export type LatestRelease =
  RestEndpointMethodTypes["repos"]["getLatestRelease"]["response"]["data"];

const { BASE_URL } = import.meta.env;

async function getLatestRelease(): Promise<LatestRelease> {
  const octokit = new Octokit({ auth: import.meta.env.GITHUB_TOKEN });

  const latestRelease = await octokit.rest.repos.getLatestRelease({
    owner: GITHUB_OWNER,
    repo: GITHUB_REPO,
  });

  return latestRelease.data;
}

const release = await getLatestRelease();

const assetX64 = release.assets.find((e) => /windows-x64\.zip/.test(e.name));
if (!assetX64) throw new Error("Windows x64 asset not found!");
---

<Layout lang="en" title="How to use OBS Background Removal on Windows">
  <Fragment slot="head-info">
    <meta
      name="description"
      content="How to use OBS Background Removal on Windows"
    />
    <link
      rel="canonical"
      href={withTrailingSlash(joinURL(PRODUCTION_BASE_URL, "windows"))}
    />
  </Fragment>

  <main class="white-box">
    <h1>Install OBS Background Removal on Windows</h1>

    <ol>
      <li>
        <strong>Download the Plugin:</strong><br />
        <a href={assetX64.browser_download_url} download>
          Click here to download the latest Windows version (ZIP)
        </a>
      </li>
      <li>
        <strong>Extract the ZIP File:</strong><br />
        Right-click the downloaded ZIP file and select <em>Extract All...</em>
      </li>
      <li>
        <strong>Copy Files to OBS Directory:</strong><br />
        Move the extracted `obs-backgroundremoval` folder into your OBS Studio installation folder.<br />
        <code>C:\ProgramData\obs-studio\plugins</code>
      </li>
      <li>
        <strong>Restart OBS Studio:</strong><br />
        Close OBS Studio if it's running, then open it again.
      </li>
      <li>
        <strong>Usage:</strong><br />
        See the <a href={joinURL(BASE_URL, "usage/")}>usage page</a> for how to use
        the plugin.
      </li>
    </ol>

    <p>All set!</p>

    <p>
      <a href={joinURL(BASE_URL, "/")}>Back to the top page</a>
    </p>
  </main>
</Layout>

<style>
  pre {
    overflow: scroll;
  }
</style>
